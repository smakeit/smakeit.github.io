<!doctype html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="ENU Token Creator - Create A Token By Youself On Enumivo">
        <meta name="author" content="smakeit">
        <link rel="shortcut icon" href="assets/img/enu-logo.png">
    
        <title>ENU Token Creator - ENU一键发币</title>
    
        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link href="https://cdn.bootcss.com/bootstrap-select/1.13.2/css/bootstrap-select.min.css" rel="stylesheet">
        
        <!-- Custom styles for this template -->
        <link href="assets/css/main.css" rel="stylesheet">
        <link href='https://cdn.baomitu.com/index/fonts/css?family=Montserrat' rel='stylesheet' type='text/css'>
        <link href='https://cdn.baomitu.com/index/fonts/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
        
</head>
<body ng-app="myApp" ng-controller="myCtrl">
        <a class="navbar-brand" style="margin-left: 20px; margin-top: 15px; font-size:25px; font-weight: 800; color: white" href="#">ENU Token Creator</a>

        <div class="container">
                        <div class="col-md-4 m-auto"> 
                            <div class="card" style="margin-top:50px;">
                                <div class="card-body">
                                    <ul id="myTab" class="nav nav-tabs">
                                        <li class="nav-item">
                                                <a class="nav-link active" href="#create" data-toggle="tab">创建/Create</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="#transfer" data-toggle="tab">转账/Transfer</a>
                                        </li>
                                    </ul>
                                    <div id="myTabContent" class="tab-content">
                                        <div class="tab-pane active" id="create">
                                            <br>
                                            <p class="card-text text-center" style="color: dimgray;margin-bottom: 0px;">创建发行你的专属Token</p>
                                            <p class="card-text text-center" style="color: dimgray;">Create your token by yourself</p>
                                            <div class="form-group">
                                                <label for="inputAccount" class="inputLabel">发币账户/Issuer</label>
                                                <input type="account" id="inputAccount" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount" class="inputLabel">发币数量/Amount</label>
                                                <input type="amount" id="inputAmount" class="form-control" placeholder="例如： 10000000.0000" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputSymbol" class="inputLabel">发币符号/Symbol</label>
                                                <input type="symbol" id="inputSymbol" class="form-control" placeholder="例如： SYS" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputFee" id="labelFee" class="inputLabel">支付费用/Fee(ENU)</label>
                                                <input type="fee" id="inputFee" class="form-control" readonly value="3.0000" required>
                                            </div>
                                            <button type="button" id="createToken" class="btn btn-secondary btn-block" disabled="disabled" style="margin-top: 20px;">发币/Create</button>
                                        </div>
                                        <div class="tab-pane fade" id="transfer">
                                            <br>
                                            <p class="card-text text-center" style="color:dimgray;margin-bottom: 0px;">将你创建的Token转账</p>
                                            <p class="card-text text-center" style="color:dimgray">Tranfer your token</p>
                                            <div class="form-group">
                                                <label for="inputSender" class="inputLabel">发送账户/Sender</label>
                                                <input type="account" id="inputSender" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputReceiver" class="inputLabel">接收账户/Receiver</label>
                                                <input type="account" id="inputReceiver" class="form-control" placeholder="例如： enuswsmakeit" required>                                    
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount2" class="inputLabel">转账数量/Quantity</label>
                                                
                                                <div class="input-group">
                                                        <select class="form-control selectpicker col-sm-3" id="tokenSel" data-live-search="true" data-style="btn btn-default">
                                                                                   
                                                        </select>
                                                <input type="amount" id="inputAmount2" class="form-control" placeholder="例如： 10.0000" required>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputMemo" class="inputLabel">备注/Memo</label>
                                                <input type="memo" id="inputMemo" class="form-control" required>
                                            </div>
                                      
                                            <button type="button" id="sendToken" class="btn btn-secondary btn-block" disabled="disabled" style="margin-top: 20px;">转账/Transfer</button>
                                         </div>
                                      </div>
                                </div>
                            </div>
                        </div>
        </div>

        <div id="c">
                <div class="container" >
                        <p>By <a href="https://enumivo.com/topic/830-smakeits-introduction/" style="color: gray;" target="_blank">smakeit</a></p>
                    </div>
        </div>
</body>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://cdn.bootcss.com/smoothscroll/1.3.8/SmoothScroll.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/i18n/defaults-zh_CN.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/enujs@16.0.8/lib/enu.min.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="assets/js/common.1.js?version=1.1.3"></script>
<script type="text/javascript">
initIronman(cb);
function cb(ironman, enu, requiredFields, account, arrTokenBalance) {
    function BalanceRefresh() {
        enu.getTableRows({
            code: 'tokencreator',
            scope: account.name,
            table: 'accounts',
            limit: 500,
            json: true
        }).then(table => {
            let length = table.rows.length;
            $('#tokenSel').empty();
            var opts = "";
            arrTokenBalance = [];
            for(let i=0;i<length;i++ ){
                var balance = table.rows[i].balance;
                var symbol = balance.split(" ")[1];
                arrTokenBalance.push(balance.split(" ")[0]);
                opts += "<option value='"+i+"'>"+symbol+"</option>";
            }
            $('#tokenSel').append(opts);
            $('#tokenSel').selectpicker('refresh');
            if(arrTokenBalance.length > 0) {
                $('#inputAmount2').attr('placeholder','余额balance: '+arrTokenBalance[0]);
            }
        });
    };

    $("#tokenSel").change(function() {
        if(arrTokenBalance.length > 0) {
            $('#inputAmount2').attr('placeholder','余额balance: '+arrTokenBalance[$("#tokenSel option:selected").val()]);
        }
    });
    $('#sendToken').on('click', function (event) {
                console.log("sendToken Button Clicked");
                event.preventDefault();
                let sender = $('#inputSender').val();
                //检查输入格式
                if(sender == ""){
                    alert("发送账户不能为空");
                    return;
                }
                let receiver = $('#inputReceiver').val();
                //检查输入格式
                if(receiver == ""){
                    alert("接收账户不能为空");
                    return;
                }
                var symbol=$("#tokenSel option:selected").text();
                let amount = $('#inputAmount2').val();
                let balance = arrTokenBalance[$("#tokenSel option:selected").val()];
                if (parseFloat(amount).toString() == "NaN") {
                    alert("填写转账数量错误");
                    return;
                }
                if (parseFloat(balance).toString() == "NaN") {
                    alert("获取余额数量错误");
                    return;
                }
                if (parseFloat(amount) >  parseFloat(balance)) {
                    alert("余额不足");
                    return;
                }
                let amountTmp = parseFloat(amount).toFixed(GetPrecision(balance));

                let quantity = amountTmp + " " + symbol;

                let memo = $('#inputMemo').val();

                //转账token
                enu.contract('tokencreator', {
                    requiredFields
                }).then(contract => {
                    contract.transfer( sender, receiver, quantity, memo ,{authorization: sender}).then(trx => {
                        //BalanceRefresh();
                        let newBalance = (parseFloat(balance) - parseFloat(amount)).toFixed(GetPrecision(balance));
                        arrTokenBalance[$("#tokenSel option:selected").val()] = newBalance.toString();
                        $('#inputAmount2').attr('placeholder','余额balance: '+newBalance.toString());

                        let url = `http://enumivo.qsx.io/transactions/${trx.transaction_id}`;
                        console.log("trans success", url);
                        //$('.message-transfer').show(400);
                        //$('#j_transaction_id').html(trx.transaction_id);
                        //$('#j_result').attr('href', url);
                        alert("转账成功: "+ url);
                    }).catch(e => {
                        console.log("error", e);
                        if (e.toString().includes("overdrawn balance")) {
                            alert("No money, go back to Getting Started and refill")
                        }
                        alert(e || 'Server Error');
                    })
                });
    });
    $('#createToken').on('click', function (event) {
            console.log("createToken Button Clicked");
            event.preventDefault();
            let accountName = $('#inputAccount').val();
            
            //检查输入格式
            if(accountName == ""){
              alert("账户不能为空");
              return;
            }
            let amount = $('#inputAmount').val();
            if (parseFloat(amount).toString() == "NaN") {
                alert("请检查发币数量或精度");
                return;
            }
            if(-1 == parseFloat(amount).toString().indexOf(".")) {
                alert("请填写发币精度，小数点后几位代表精度是几");
                return;
            }
            let wei = (amount.split(".")[1]).length;
            if(wei > 18)
            {
              alert("小数点后不能超过18位");
              return;
            }
            let symbol = ($('#inputSymbol').val()).toUpperCase();
            if(symbol == "" || " " == symbol.match(" ") || symbol.length > 6){
              alert("符号格式不对，不能为空，不能超过6位或有空格");
              return;
            }
            let supply = amount + " " + symbol;

            let quantity = $('#inputFee').val() + " ENU";

            let contractAcnt = "tokencreator";

            //发送enu至合约账户
            enu.contract('enu.token', {
                 requiredFields
             }).then(contract => {
                 contract.transfer( accountName, contractAcnt, quantity, supply ,{authorization: accountName}).then(trx => {
                    BalanceRefresh();
                     let url = `http://enumivo.qsx.io/transactions/${trx.transaction_id}`;
                     console.log("trans success", url);
                     //$('.message-transfer').show(400);
                     //$('#j_transaction_id').html(trx.transaction_id);
                     //$('#j_result').attr('href', url);
                     alert("创建成功: "+ url);
                 }).catch(e => {
                     console.log("error", e);
                     if (e.toString().includes("overdrawn balance")) {
                         alert("No money, go back to Getting Started and refill")
                     }
                     alert(e || 'Server Error');
                 })
             });
    });
    function GetPrecision(balance) {
        if(-1 == balance.indexOf(".")) {
            return 0;
        } 
        else {
            return (balance.split(".")[1]).length;
        }
    };
}

</script>