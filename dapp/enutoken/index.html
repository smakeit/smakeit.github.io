<!doctype html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="ENU Capsule - A Gift From The Future On Enumivo">
        <meta name="author" content="enufutureone">
        <link rel="shortcut icon" href="assets/img/enu-logo.png">
    
        <title>ENU Token Creator - Creat A Token By Youself On Enumivo</title>
    
        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link href="https://cdn.bootcss.com/bootstrap-select/1.13.2/css/bootstrap-select.min.css" rel="stylesheet">
        
        <!-- Custom styles for this template -->
        <link href="assets/css/main.css" rel="stylesheet">
        <link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
        <style>
                body{
                    background: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzI4MjgyOCI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==");
                }
        </style>
</head>
<body>
        <a class="navbar-brand" style="margin-left: 20px; margin-top: 15px; font-size:25px; font-weight: 800; color: white" href="#">ENU Token Creator</a>

        <div class="container">
                        <div class="col-md-4 m-auto"> 
                            <div class="card" style="margin-top:50px;">
                                <div class="card-body">
                                    <ul id="myTab" class="nav nav-tabs">
                                        <li class="nav-item">
                                                <a class="nav-link active" href="#create" data-toggle="tab">创建</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="#transfer" data-toggle="tab">转账</a>
                                        </li>
                                    </ul>
                                    <div id="myTabContent" class="tab-content">
                                        <div class="tab-pane active" id="create">
                                            <br>
                                            <p class="card-text text-center" style="color: dimgray">创建发行你的专属Token</p>
                                            <div class="form-group">
                                                <label for="inputAccount" class="inputLabel">发币账户</label>
                                                <input type="account" id="inputAccount" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount" class="inputLabel">发币数量</label>
                                                <input type="amount" id="inputAmount" class="form-control" placeholder="例如： 10000000.0000" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputSymbol" class="inputLabel">发币符号</label>
                                                <input type="symbol" id="inputSymbol" class="form-control" placeholder="例如： SYS" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputFee" id="labelFee" class="inputLabel">支付费用(ENU)</label>
                                                <input type="fee" id="inputFee" class="form-control" readonly value="3.0000" required>
                                            </div>
                                            <button type="button" id="createToken" class="btn btn-success btn-block" style="margin-top: 20px;">发币</button>
                                        </div>
                                        <div class="tab-pane fade" id="transfer">
                                            <br>
                                            <p class="card-text text-center" style="color:dimgray">将你创建的Token转账</p>
                                            <div class="form-group">
                                                <label for="inputSender" class="inputLabel">发送方</label>
                                                <input type="account" id="inputSender" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputReceiver" class="inputLabel">接收方</label>
                                                <input type="account" id="inputReceiver" class="form-control" placeholder="例如： enuswsmakeit" required>                                    
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount2" class="inputLabel">转账数量</label>
                                                <div class="input-group">
                                                        <select class="form-control selectpicker col-sm-3" id="tokenSel" data-live-search="true" data-style="btn btn-default">
                                                                                   
                                                        </select>
                                                <input type="amount" id="inputAmount2" class="form-control" placeholder="例如： 10.0000" required>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputMemo" class="inputLabel">备注(Memo)</label>
                                                <input type="amount" id="inputMemo" class="form-control" required>
                                            </div>
                                      
                                            <button type="button" id="sendToken" class="btn btn-success btn-block" style="margin-top: 20px;">转账</button>
                                         </div>
                                      </div>
                                </div>
                            </div>
                        </div>
        </div>

        <div id="c">
                <div class="container" >
                        <p>By <a href="https://enumivo.com/topic/830-smakeits-introduction/" style="color: gray;" target="_blank">smakeit</a></p>
                    </div>
        </div>
</body>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://cdn.bootcss.com/smoothscroll/1.3.8/SmoothScroll.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/i18n/defaults-zh_CN.min.js"></script>
<!--<script src="assets/js/enu.min.js"></script>-->
<script src="https://cdn.jsdelivr.net/npm/enujs@16.0.8/lib/enu.min.js" crossorigin="anonymous"></script>
<script type="text/javascript">

document.addEventListener('ironmanLoaded', ironmanExtension => {
        console.log('ironmanExtension load');

        const ironman = window.ironman;
        //防止别的网页应用 调用window.ironman 对象
        window.ironman = null;

        // If you want to require a specific version of ironman
        //ironman.requireVersion(1.1);

        const enuNetwork = {
          blockchain: 'enu',
          chainId: 'cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f'
        };

        //给用户推荐网络， 第一次需要授权
        ironman.suggestNetwork(enuNetwork);

        // ironman.getIdentity 用户授权页面
        ironman.getIdentity({
          accounts: [enuNetwork]
        }).then(
          identity => {

          //1. 用户授权完成后，获取用户的ENU帐号名字（12位长度），传给后台完成登录or注册操作操作
          const account = identity.accounts.find(acc => acc.blockchain === 'enu');
          console.log("1. 用户授权完成后，获取用户信息，提交给后台完成用户登录or注册", identity);
          //ENU参数，仅签名不广播交易
          const enuOptions = {
            broadcast: true,
            chainId: "cf057bbfb72640471fd910bcb67639c22df9f92470936cddc1ade0e2f2e7dc4f"
          }
          //获取ENU instance
          const enu = ironman.enu(enuNetwork, Enu, enuOptions, "https");

          const requiredFields = {
            accounts: [enuNetwork]
          }
          
          var arrBalance = [];

          $('#inputAccount').val(account.name);
          $('#inputSender').val(account.name);

          enu.getTableRows({
                code: "tokencreator",
                scope: account.name,
                table: "accounts",
                limit: 500,
                json: true
              }).then(table => {
                let length = table.rows.length;
                //let balance = table.rows[0].balance;
                $("#tokenSel").empty();
                var opts = "";
                for(let i=0;i<length;i++ ){
                    var balance = table.rows[i].balance;
                    var symbol = balance.split(" ")[1];
                    arrBalance.push(balance.split(" ")[0]);
                    opts += "<option value='"+i+"'>"+symbol+"</option>";
                }
                $("#tokenSel").append(opts);
                $("#tokenSel").selectpicker('refresh');

		        // window.setTimeout(function() {
                //     $("#alertSuccess").text("ENU");
                //     $("#alertSuccess").alert('close');
                //     }, 2000);
          });

          

          $('#createToken').on('click', function (event) {
            console.log("createToken Button Clicked");
            event.preventDefault();
            let account = $('#inputAccount').val();
            
            //检查输入格式
            if(account == ""){
              alert("账户不能为空");
            }
            let amount = $('#inputAmount').val();
            let wei = (amount.split(".")[1]).length;
            if(wei > 18)
            {
              alert("小数点后不能超过18位");
            }
            let symbol = ($('#inputSymbol').val()).toUpperCase();
            if(symbol == "" || " " == symbol.match(" ") || symbol.length > 6){
              alert("符号格式不对，不能为空，不能超过6位或有空格");
            }
            let supply = amount + " " + symbol;

            let quantity = $('#inputFee').val() + " ENU";

            let contractAcnt = "tokencreator";

            //发送enu至合约账户
            enu.contract('enu.token', {
                 requiredFields
             }).then(contract => {
                 contract.transfer( account, contractAcnt, quantity, supply ).then(trx => {
                     console.log("signature", trx);
                     let url = `http://enumivo.qsx.io/transactions/${trx.transaction_id}`;
                     console.log("trans success", url);
                     //$('.message-transfer').show(400);
                     //$('#j_transaction_id').html(trx.transaction_id);
                     //$('#j_result').attr('href', url);
                     alert("创建成功: "+ url);
                 }).catch(e => {
                     console.log("error", e);
                     if (e.toString().includes("overdrawn balance")) {
                         alert("No money, go back to Getting Started and refill")
                     }
                     alert(e || 'Server Error');
                 })
             });
          });
          $('#sendToken').on('click', function (event) {
                console.log("transToken Button Clicked");
                let sender = $('#inputSender').val();
                //检查输入格式
                if(sender == ""){
                    alert("发送账户不能为空");
                }
                let receiver = $('#inputReceiver').val();
                //检查输入格式
                if(receiver == ""){
                    alert("接收账户不能为空");
                }
                var symbol=$("#tokenSel option:selected").text();
                let amount = $('#inputAmount2').val();
                let balance = arrBalance[$("#tokenSel option:selected").val()];
                if (parseFloat(amount).toString() == "NaN") {
                    alert("填写转账数量错误");
                }
                if (parseFloat(balance).toString() == "NaN") {
                    alert("获取余额数量错误");
                }
                if (parseFloat(amount) >  parseFloat(balance)) {
                    alert("余额不足");
                }
                let quantity = amount + " " + symbol;
                let memo = $('#inputMemo').val();

                //发送token至合约账户
                enu.contract('tokencreator', {
                    requiredFields
                }).then(contract => {
                    contract.tokentrans( sender, receiver, quantity, memo ).then(trx => {
                        console.log("signature", trx);
                        let url = `http://enumivo.qsx.io/transactions/${trx.transaction_id}`;
                        console.log("trans success", url);
                        //$('.message-transfer').show(400);
                        //$('#j_transaction_id').html(trx.transaction_id);
                        //$('#j_result').attr('href', url);
                        alert("转账成功: "+ url);
                    }).catch(e => {
                        console.log("error", e);
                        if (e.toString().includes("overdrawn balance")) {
                            alert("No money, go back to Getting Started and refill")
                        }
                        alert(e || 'Server Error');
                    })
                });
          });

        });
    });

</script>