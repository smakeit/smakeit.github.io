<!doctype html>
<html lang="en">
<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="ENU Token Creator - Create A Token By Youself On Enumivo">
        <meta name="author" content="smakeit">
        <link rel="shortcut icon" href="assets/img/enu-logo.png">
    
        <title>ENU Token Creator - ENU一键发币</title>
    
        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css">
        <link href="https://cdn.bootcss.com/bootstrap-select/1.13.2/css/bootstrap-select.min.css" rel="stylesheet">
        
        <!-- Custom styles for this template -->
        <link href="assets/css/main.css" rel="stylesheet">
        <link href='https://cdn.baomitu.com/index/fonts/css?family=Montserrat' rel='stylesheet' type='text/css'>
        <link href='https://cdn.baomitu.com/index/fonts/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
        <style>
                body{
                    background: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNSI+CjxyZWN0IHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgZmlsbD0iIzI4MjgyOCI+PC9yZWN0Pgo8Y2lyY2xlIGN4PSIzIiBjeT0iNC4zIiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIzIiBjeT0iMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+CjxjaXJjbGUgY3g9IjEwLjUiIGN5PSIxMi41IiByPSIxLjgiIGZpbGw9IiMzOTM5MzkiPjwvY2lyY2xlPgo8Y2lyY2xlIGN4PSIxMC41IiBjeT0iMTEuMyIgcj0iMS44IiBmaWxsPSJibGFjayI+PC9jaXJjbGU+Cjwvc3ZnPg==");
                }
        </style>
</head>
<body ng-app="myApp" ng-controller="myCtrl">
        <a class="navbar-brand" style="margin-left: 20px; margin-top: 15px; font-size:25px; font-weight: 800; color: white" href="#">ENU Token Creator</a>

        <div class="container">
                        <div class="col-md-4 m-auto"> 
                            <div class="card" style="margin-top:50px;">
                                <div class="card-body">
                                    <ul id="myTab" class="nav nav-tabs">
                                        <li class="nav-item">
                                                <a class="nav-link active" href="#create" data-toggle="tab">创建/Create</a>
                                        </li>
                                        <li class="nav-item">
                                                <a class="nav-link" href="#transfer" data-toggle="tab">转账/Transfer</a>
                                        </li>
                                    </ul>
                                    <div id="myTabContent" class="tab-content">
                                        <div class="tab-pane active" id="create">
                                            <br>
                                            <p class="card-text text-center" style="color: dimgray;margin-bottom: 0px;">创建发行你的专属Token</p>
                                            <p class="card-text text-center" style="color: dimgray;">Create your token by yourself</p>
                                            <div class="form-group">
                                                <label for="inputAccount" class="inputLabel">发币账户/Issuer</label>
                                                <input type="account" id="inputAccount" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount" class="inputLabel">发币数量/Amount</label>
                                                <input type="amount" id="inputAmount" class="form-control" placeholder="例如： 10000000.0000" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputSymbol" class="inputLabel">发币符号/Symbol</label>
                                                <input type="symbol" id="inputSymbol" class="form-control" placeholder="例如： SYS" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputFee" id="labelFee" class="inputLabel">支付费用/Fee(ENU)</label>
                                                <input type="fee" id="inputFee" class="form-control" readonly value="3.0000" required>
                                            </div>
                                            <button type="button" id="createToken" class="btn btn-success btn-block" disabled="disabled" style="margin-top: 20px;">发币/Create</button>
                                        </div>
                                        <div class="tab-pane fade" id="transfer">
                                            <br>
                                            <p class="card-text text-center" style="color:dimgray;margin-bottom: 0px;">将你创建的Token转账</p>
                                            <p class="card-text text-center" style="color:dimgray">Tranfer your token</p>
                                            <div class="form-group">
                                                <label for="inputSender" class="inputLabel">发送账户/Sender</label>
                                                <input type="account" id="inputSender" class="form-control" placeholder="例如： enuswsmakeit" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputReceiver" class="inputLabel">接收账户/Receiver</label>
                                                <input type="account" id="inputReceiver" class="form-control" placeholder="例如： enuswsmakeit" required>                                    
                                            </div>
                                            <div class="form-group">
                                                <label for="inputAmount2" class="inputLabel">转账数量/Quantity</label>
                                                
                                                <div class="input-group">
                                                        <select class="form-control selectpicker col-sm-3" id="tokenSel" data-live-search="true" data-style="btn btn-default">
                                                                                   
                                                        </select>
                                                <input type="amount" id="inputAmount2" class="form-control" placeholder="例如： 10.0000" required>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="inputMemo" class="inputLabel">备注/Memo</label>
                                                <input type="amount" id="inputMemo" class="form-control" required>
                                            </div>
                                      
                                            <button type="button" id="sendToken" class="btn btn-success btn-block" disabled="disabled" style="margin-top: 20px;">转账/Transfer</button>
                                         </div>
                                      </div>
                                </div>
                            </div>
                        </div>
        </div>

        <div id="c">
                <div class="container" >
                        <p>By <a href="https://enumivo.com/topic/830-smakeits-introduction/" style="color: gray;" target="_blank">smakeit</a></p>
                    </div>
        </div>
</body>

<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"></script>
<script src="https://cdn.bootcss.com/smoothscroll/1.3.8/SmoothScroll.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/bootstrap-select.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap-select/1.13.2/js/i18n/defaults-zh_CN.min.js"></script>
<script type="text/javascript" src="assets/js/tp.20180824.js"></script>
<script type="text/javascript">

$(document).ready(function () {
    if(!tp.isConnected()) {
        alert("tp钱包连接失败");
        return;
    }
    $('#createToken').length && $('#createToken').prop('disabled', false);
    $('#sendToken').length && $('#sendToken').prop('disabled', false);
    var acntName = '';
    var acntAddress = '';
    var arrBalance = [];
    tp.getCurrentWallet().then(function (result) {
        if (result.result) {
            acntName = result.data.name;
            acntAddress = result.data.address;

            $('#inputAccount').val(acntName);
            $('#inputSender').val(acntName);
            $('#inputAccount').length && $('#inputAccount').prop('disabled', true);
            $('#inputSender').length && $('#inputSender').prop('disabled', true);
        }
        else{
            alert("获取当前用户信息失败");
            return;
        };
    });
    tp.getEnuTableRows({
        json: true,
        code: 'enu.token',
        scope: acntName,
        table: 'accounts',
        limit: 20
    }).then(function (result) {
        alert(result.data.rows.length);
        if (result.result) {
            let length = result.data.rows.length;
            $("#tokenSel").empty();
            var opts = "";
            for(let i=0;i<length;i++ ){
                var balance = result.data.rows[i].balance;
                var symbol = balance.split(" ")[1];
                arrBalance.push(balance.split(" ")[0]);
                opts += "<option value='"+i+"'>"+symbol+"</option>";
            }
            $("#tokenSel").append(opts);
            $("#tokenSel").selectpicker('refresh');
            if(arrBalance.length > 0) {
                $('#inputAmount2').attr('placeholder','余额balance: '+arrBalance[0]);
            }
        }
        else{
            alert("获取当前用户token信息失败");
            return;
        };
    });

    $("#tokenSel").change(function() {
        if(arrBalance.length > 0) {
            $('#inputAmount2').attr('placeholder','余额balance: '+arrBalance[$("#tokenSel option:selected").val()]);
        }
    });

    $('#sendToken').on('click', function (event) {
                console.log("sendToken Button Clicked");
                event.preventDefault();
                let sender = $('#inputSender').val();
                //检查输入格式
                if(sender == ""){
                    alert("发送账户不能为空");
                    return;
                }
                let receiver = $('#inputReceiver').val();
                //检查输入格式
                if(receiver == ""){
                    alert("接收账户不能为空");
                    return;
                }
                var symbol=$("#tokenSel option:selected").text();
                let amount = $('#inputAmount2').val();
                let balance = arrTokenBalance[$("#tokenSel option:selected").val()];
                if (parseFloat(amount).toString() == "NaN") {
                    alert("填写转账数量错误");
                    return;
                }
                if (parseFloat(balance).toString() == "NaN") {
                    alert("获取余额数量错误");
                    return;
                }
                if (parseFloat(amount) >  parseFloat(balance)) {
                    alert("余额不足");
                    return;
                }
                let quantity = amount + " " + symbol;
                let memo = $('#inputMemo').val();

                //转账token
                tp.pushEnuAction({
                    actions: [
                        {
                            account: 'tokencreator',
                            name: 'transfer',
                            authorization: [{
                                actor: sender,
                                permission: 'active'
                            }],
                            data: {
                                from: sender,
                                to: receiver,
                                quantity: quantity,
                                memo: memo
                            }
                        }
                    ],
                    address: acntAddresss,
                    account: sender
                }).then(function (result) {
                    if (result.result) {
                        let url = `http://enumivo.qsx.io/transactions/${result.data.transactionId}`;
                        alert("转账成功: "+ url);
                    }
                    else{
                        alert("转账token失败");
                        return;
                    };
                });
    });

    $('#createToken').on('click', function (event) {
            console.log("createToken Button Clicked");
            event.preventDefault();
            let accountName = $('#inputAccount').val();
            
            //检查输入格式
            if(accountName == ""){
              alert("账户不能为空");
              return;
            }
            let amount = $('#inputAmount').val();
            let wei = (amount.split(".")[1]).length;
            if(wei > 18)
            {
              alert("小数点后不能超过18位");
              return;
            }
            let symbol = ($('#inputSymbol').val()).toUpperCase();
            if(symbol == "" || " " == symbol.match(" ") || symbol.length > 6){
              alert("符号格式不对，不能为空，不能超过6位或有空格");
              return;
            }
            let supply = amount + " " + symbol;

            let quantity = $('#inputFee').val();

            let contractAcnt = "tokencreator";

            //发送enu至合约账户
            tp.enuTokenTransfer({
                from: accountName,
                to: contractAcnt,
                amount: quantity,
                tokenName: 'ENU',
                precision: 4,
                contract: 'enu.token',
                memo: supply,
                address: acntAddress
            }).then(function (result) {
                if (result.result) {
                    let url = `http://enumivo.qsx.io/transactions/${result.data.transactionId}`;
                    alert("创建成功: "+ url);
                }else {
                    alert("enu转账失败,请检查余额");
                }
            });
    });

});


</script>